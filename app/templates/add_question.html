{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h3 class="mb-4">➕ Add New Question</h3>

    <!-- Layer selection -->
    <div class="mb-3">
        <label for="layerSelect" class="form-label"><strong>Select Layer</strong></label>
        <select class="form-select" id="layerSelect">
            <option value="">-- Choose a layer --</option>
            <option value="layer1">Layer 1 – Scope & Context</option>
            <option value="layer2">Layer 2 – Actors & Entities</option>
            <option value="layer3">Layer 3 – Data Assets</option>
            <option value="layer4">Layer 4 – Architecture</option>
            <option value="layer5">Layer 5 – Security Controls</option>
            <option value="layer6">Layer 6 – Operations</option>
            <option value="layer7">Layer 7 – Threat Hypotheses</option>
        </select>
    </div>

    <!-- Question text -->
    <div class="mb-3">
        <label for="questionText" class="form-label"><strong>Question Text</strong></label>
        <textarea id="questionText" class="form-control" rows="3" placeholder="Enter your question here..."></textarea>
    </div>

    <!-- Options -->
    <div class="mb-3">
        <label class="form-label"><strong>Options</strong></label>
        <div id="optionsContainer">
            <div class="option-input-group d-flex align-items-center mb-2">
                <input type="text" class="form-control option-input" placeholder="Option 1">
            </div>
            <div class="option-input-group d-flex align-items-center mb-2">
                <input type="text" class="form-control option-input" placeholder="Option 2">
            </div>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addOptionBtn">+ Add Option</button>
    </div>

    <!-- Submit -->
    <div class="text-end">
        <button id="submitBtn" type="button" class="btn btn-success">Add Question</button>
    </div>

    <div id="statusMsg" class="mt-3"></div>
</div>

<script>
    const addOptionBtn = document.getElementById('addOptionBtn');
    const optionsContainer = document.getElementById('optionsContainer');
    const submitBtn = document.getElementById('submitBtn');
    const layerSelect = document.getElementById('layerSelect');
    const questionText = document.getElementById('questionText');
    const statusMsg = document.getElementById('statusMsg');
    let optionCount = 2;

    addOptionBtn.addEventListener('click', () => {
        optionCount++;
        const optionGroup = document.createElement('div');
        optionGroup.classList.add('option-input-group', 'd-flex', 'align-items-center', 'mb-2');
        optionGroup.innerHTML = `
            <input type="text" class="form-control option-input me-2" placeholder="Option ${optionCount}">
            <button type="button" class="btn btn-outline-danger btn-sm removeOptionBtn">−</button>
        `;
        optionsContainer.appendChild(optionGroup);

        optionGroup.querySelector('.removeOptionBtn').addEventListener('click', () => {
            optionGroup.remove();
        });
    });

    submitBtn.addEventListener('click', async () => {
        statusMsg.textContent = "";
        const layer = layerSelect.value;
        const text = questionText.value.trim();
        if (!layer) {
            statusMsg.textContent = "Please select a layer.";
            statusMsg.className = "text-danger";
            return;
        }
        if (!text) {
            statusMsg.textContent = "Please enter question text.";
            statusMsg.className = "text-danger";
            return;
        }
        const options = Array.from(document.querySelectorAll('.option-input'))
            .map(i => i.value.trim())
            .filter(v => v.length > 0);

        submitBtn.disabled = true;
        submitBtn.textContent = "Adding...";

        try {
            const res = await fetch("{{ url_for('main.add_question') }}", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({layer, text, options})
            });
            const j = await res.json();
            if (res.ok && j.ok) {
                statusMsg.className = "text-success";
                statusMsg.textContent = "Question added.";
                questionText.value = "";
                document.querySelectorAll('.option-input').forEach((el, idx) => {
                    if (idx >= 2) el.parentElement.remove();
                    else el.value = "";
                });
            } else {
                statusMsg.className = "text-danger";
                statusMsg.textContent = j.error || "Failed to add question";
            }
        } catch (err) {
            statusMsg.className = "text-danger";
            statusMsg.textContent = err.message || "Network error";
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Add Question";
        }
    });
</script>
{% endblock %}